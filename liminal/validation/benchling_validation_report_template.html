<!DOCTYPE html>
<html>

<head>
    <title>Benchling Validation Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.4.0/font/bootstrap-icons.min.css">

    <style>
        .chart-box {
            height: 40vh;
            max-width: 80vw;
            /* Changed from width to max-width to prevent stretching beyond the container */
            margin: auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .carousel-indicators li {
            background-color: grey;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            filter: invert(50%)
        }

        .carousel-item {
            padding-bottom: 40px;
        }

        .collapse-indicator {
            float: right;
            transition: transform 0.3s ease;
        }

        .collapsed>.collapse-indicator {
            transform: rotate(-90deg);
        }

        .not-collapsed>.collapse-indicator {
            transform: rotate(90deg);
        }

        .icon-spacing {
            margin-left: 5px;
        }

        .list-group-item {
            border-left: 5px solid;
        }

        .list-group-item.HIGH {
            border-color: salmon;
        }

        .list-group-item.MED {
            border-color: sandybrown;
        }

        .list-group-item.LOW {
            border-color: steelblue;
        }

        .list-group-item.UNEXPECTED {
            border-color: darkgrey;
        }

        .dropdown-container {
            display: flex;
            justify-content: left;
        }

        .entity-info-main {
            color: #000;
        }

        .entity-info {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            color: darkgrey;
        }
    </style>
</head>

<body>
    <header class="text-center my-4">
        <h1 class="text-secondary">Benchling Validation Summary: {{datetime}}</h1>
    </header>
    <div class="container">
        <div id="chartCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
            <ol class="carousel-indicators">
                <li data-target="#chartCarousel" data-slide-to="0" class="active"></li>
                <li data-target="#chartCarousel" data-slide-to="1"></li>
            </ol>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="container">
                        <div class="chart-box">
                            <canvas id="summaryByLevels"></canvas>
                        </div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="container">
                        <div class="chart-box">
                            <canvas id="summaryByValidatorName"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <a class="carousel-control-prev" href="#chartCarousel" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#chartCarousel" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
        <div class="dropdown-container">
            <div class="dropdown mb-2 mr-4">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="creatorDropdown"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select Creator
                </button>
                <div class="dropdown-menu" aria-labelledby="creatorDropdown">
                    <a class="dropdown-item" href="#" onclick="updateDropdownSelection('creatorDropdown', 'All')">Select
                        Creator</a>
                    {% for creator in creator_names %}
                    <a class="dropdown-item" href="#"
                        onclick="updateDropdownSelection('creatorDropdown', '{{ creator }}')">{{ creator }}</a>
                    {% endfor %}
                </div>
            </div>
            <div class="dropdown mb-2">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="validatorDropdown"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Select Validator
                </button>
                <div class="dropdown-menu" aria-labelledby="validatorDropdown">
                    <a class="dropdown-item" href="#"
                        onclick="updateDropdownSelection('validatorDropdown', 'All')">Select Validator</a>
                    {% for validator in validator_names %}
                    <a class="dropdown-item" href="#"
                        onclick="updateDropdownSelection('validatorDropdown', '{{ validator }}')">{{ validator }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div></div>
    </div>
    <div class="container">
        {% for model in model_data %}
        <div class="card my-3 model-card">
            <div class="card-header">
                {% if model.model_name not in non_entity_models %}
                <a href="{{ model.model_query }}" target="_blank" style="color: inherit;">
                    <span class="model-name-header-text" style="font-weight: bold; font-size: larger;"
                        id="{{ model.model_name | replace(' ', '') }}">{{ model.model_name }}</span>
                    <i class="bi bi-box-arrow-up-right icon-spacing"></i>
                </a>
                {% else %}
                <span class="model-name-header-text" style="font-weight: bold; font-size: larger;"
                    id="{{ model.model_name | replace(' ', '') }}">
                    {{model.model_name }}
                </span>
                {% endif %}
                <span id="levelCount{{ model.model_name | replace(' ', '') }}"></span>
                <a href="#collapse{{ model.model_name }}" data-toggle="collapse" role="button" aria-expanded="false"
                    aria-controls="collapse{{ model.model_name }}" class="collapse-indicator">&#x25B2;</a>
            </div>
            <div class="collapse" id="collapse{{ model.model_name }}">
                <div class="card card-body">
                    {% for entity in model.entity_messages %}
                    <div class="card my-3 list-group-item {{ entity.level }}" data-creator="{{ entity.creator_name }}"
                        data-validator="{{ entity.validator_name }}">
                        {% if model.model_name not in non_entity_models %}
                        <div class="card-header">
                            <a href="{{ entity.web_url }}" target="_blank" style="color: inherit;">
                                <span style="font-weight: bold; font-size: larger;">{{ entity.entity_name }}</span><i
                                    class="bi bi-box-arrow-up-right icon-spacing"></i>
                            </a>
                        </div>
                        {% endif %}
                        <div class="card-body">
                            <p class="card-text entity-info-main">{{ entity.error_message }}</p>
                            {% if entity.tissue_ontology %}
                            <p class="card-text entity-info">Tissue Ontology: {{ entity.tissue_ontology }}</p>
                            {% endif %}
                            {% if model.model_name not in non_entity_models %}
                            <p class="card-text entity-info">Validator: {{ entity.validator_name }}</p>
                            <p class="card-text entity-info">Creator: {{ entity.creator_name }}</p>
                            <p class="card-text entity-info">Updated Date: {{ entity.updated_date }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            updateLevelCounts();
            var summary_levels_table_data = {{ summary_levels_table_data | tojson | safe
        }};
        var summary_validator_table_data = {{ summary_validator_table_data | tojson | safe }};

        renderStackedBarChart('summaryByLevels', "Invalid Benchling Entities Grouped By Severity Level", summary_levels_table_data.labels, summary_levels_table_data.data, severity_levels);
        renderStackedBarChart('summaryByValidatorName', "Invalid Benchling Entities Grouped By Error Type", summary_validator_table_data.labels, summary_validator_table_data.data);

        $('.collapse-indicator').on('click', function (e) {
            e.stopPropagation();
            var cardCollapse = $(this).closest('.card-header').next('.collapse');
            cardCollapse.collapse('toggle');
            $(this).toggleClass('collapsed not-collapsed');
            if ($(this).hasClass('not-collapsed')) {
                $(this).html('&#x25BC;');
            } else {
                $(this).html('&#x25B2;');
            }
        });
        });

        function updateLevelCounts() {
            var models = document.querySelectorAll('.model-card');
            models.forEach(function (model) {
                var modelId = model.querySelector('.model-name-header-text').id;
                var entities = model.querySelectorAll('.list-group-item');
                var counts = { HIGH: 0, MED: 0, LOW: 0, UNEXPECTED: 0 };
                entities.forEach(function (entity) {
                    var level = entity.classList[3];
                    if (entity.classList.contains('filteredcreatorDropdown') || entity.classList.contains('filteredvalidatorDropdown')) {
                        return;
                    }
                    counts[level]++;
                });
                countText = ""
                Object.entries(counts).forEach(function ([key, value], index) {
                    if (value > 0) {
                        countText += key + ': ' + value + ' | ';
                    }
                });
                countText = countText.slice(0, -3);
                document.getElementById('levelCount' + modelId).textContent = '- ' + countText;
            });
        }

        function updateDropdownSelection(dropdownId, selection) {
            var dropdownButton = document.getElementById(dropdownId);
            dropdownButton.textContent = selection;
            dropdownButton.appendChild(document.createElement('span')).className = 'caret';
            filterBySelection(dropdownId, selection);
        }

        function filterBySelection(dropdownId, selectionName) {
            var attribute = dropdownId === 'creatorDropdown' ? 'data-creator' : 'data-validator';
            var cards = document.querySelectorAll('.list-group-item');
            cards.forEach(function (card) {
                if (selectionName === 'All' || card.getAttribute(attribute) === selectionName) {
                    card.classList.remove('filtered' + dropdownId);
                    card.style.display = 'block';
                } else {
                    card.classList.add('filtered' + dropdownId);
                    if (card.classList.contains('filtered' + dropdownId) || card.classList.contains('filtered' + dropdownId)) {
                        card.style.display = 'none';
                    }
                }
            });
            updateLevelCounts();
        }

        var severity_levels = [
            { "name": "HIGH", "color": "salmon" },
            { "name": "MED", "color": "sandybrown" },
            { "name": "LOW", "color": "steelblue" },
            { "name": "UNEXPECTED", "color": "darkgrey" }
        ];

        function renderStackedBarChart(id, title, labels, data, stacks) {
            var ctx = document.getElementById(id).getContext('2d');
            var datasets = [];
            if (stacks === undefined) {
                var colors = ['lavender', 'thistle', 'plum', 'lightblue', 'powderblue', 'palegreen', 'peachpuff', 'mistyrose', 'honeydew'];
                var groups = Object.keys(data);
                stacks = groups.map(function (group, index) {
                    return { name: group, color: colors[index] };
                });
            }

            stacks.forEach(function (group, index) {
                datasets.push({
                    label: group.name,
                    data: data[group.name],
                    backgroundColor: group.color
                });
            });

            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    }
                }
            });
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>

</html>